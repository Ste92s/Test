<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Inventario — Bar/Tabacchi</title>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const LS_KEYS = { INVENTORY: "bar_inventory_v3", ORDERS: "bar_orders_v3" };
const todayISO = () => new Date().toISOString().slice(0,10);
const currency = n => n.toLocaleString("it-IT",{style:"currency",currency:"EUR"});

function App(){
  const [page,setPage] = React.useState("inventory");
  const [inventory,setInventory] = React.useState([]);
  const [orders,setOrders] = React.useState([]);
  const [newProduct,setNewProduct] = React.useState({brand:"",qty:"",price:"",minQty:""});
  const [reloadForm,setReloadForm] = React.useState({brand:"",qty:"",price:""});
  const [multiUnload,setMultiUnload] = React.useState([{brand:"",qty:""}]);
  const [filterDate,setFilterDate] = React.useState(todayISO());

  // Load localStorage
  React.useEffect(()=>{
    const inv = localStorage.getItem(LS_KEYS.INVENTORY);
    const ord = localStorage.getItem(LS_KEYS.ORDERS);
    if(inv) setInventory(JSON.parse(inv));
    if(ord) setOrders(JSON.parse(ord));
  },[]);

  // Save localStorage
  React.useEffect(()=>{ localStorage.setItem(LS_KEYS.INVENTORY,JSON.stringify(inventory)) },[inventory]);
  React.useEffect(()=>{ localStorage.setItem(LS_KEYS.ORDERS,JSON.stringify(orders)) },[orders]);

  // Alert sotto soglia
  React.useEffect(()=>{
    inventory.forEach(p=>{
      if(p.minQty && p.qty < p.minQty){
        console.warn(`⚠️ Attenzione: ${p.brand} sotto soglia (${p.qty} < ${p.minQty})`);
      }
    });
  },[inventory]);

  // --- Aggiungi nuovo prodotto ---
  function addProduct(e){
    e.preventDefault();
    if(!newProduct.brand) return alert("Inserisci marca");
    const qty = parseInt(newProduct.qty||0,10);
    const price = parseFloat(newProduct.price||0);
    const minQty = parseInt(newProduct.minQty||0,10);
    if(qty<0 || isNaN(qty)) return alert("Quantità non valida");
    if(price<0 || isNaN(price)) return alert("Prezzo non valido");

    const exists = inventory.find(p=>p.brand.toLowerCase()===newProduct.brand.trim().toLowerCase());
    if(exists){
      setInventory(prev=> prev.map(p=> p.brand.toLowerCase()===newProduct.brand.trim().toLowerCase() ? 
        {...p, qty: p.qty + qty, price: price, minQty: minQty || p.minQty} : p
      ));
    } else {
      setInventory(prev=> [...prev, {brand:newProduct.brand.trim(), qty, price, minQty}]);
    }
    setNewProduct({brand:"", qty:"", price:"", minQty:""});
    setPage("inventory");
  }

  // --- Ricarica quantità prodotto esistente ---
  function reloadProduct(e){
    e.preventDefault();
    const prod = inventory.find(p=>p.brand===reloadForm.brand);
    if(!prod) return alert("Prodotto non trovato");
    const qty = parseInt(reloadForm.qty||0,10);
    const price = parseFloat(reloadForm.price||prod.price);
    if(isNaN(qty)||qty<=0) return alert("Quantità non valida");
    if(isNaN(price)||price<0) return alert("Prezzo non valido");

    setInventory(prev=> prev.map(p=> p.brand===reloadForm.brand? {...p, qty: p.qty + qty, price} : p));
    setReloadForm({brand:"", qty:"", price:""});
    setPage("inventory");
  }

  // --- Scarico multiplo ---
  function unloadMulti(e){
    e.preventDefault();
    const updates = [...inventory];
    const newOrders = [...orders];
    for(const item of multiUnload){
      if(!item.brand) continue;
      const prod = updates.find(p=>p.brand===item.brand);
      if(!prod) continue;
      const qty = parseInt(item.qty||0,10);
      if(qty>prod.qty) { alert(`Scorte insufficienti: ${prod.brand}`); continue; }
      prod.qty -= qty;
      newOrders.push({
        id: Date.now()+Math.random(),
        brand: prod.brand,
        qty,
        unitPrice: prod.price,
        total: +(prod.price*qty).toFixed(2),
        date: new Date().toISOString()
      });
    }
    setInventory(updates);
    setOrders(newOrders);
    setMultiUnload([{brand:"",qty:""}]);
    setPage("inventory");
  }

  // --- CSV Export ---
  function exportCSV(){
    let csv = "Marca,Quantità,Prezzo,MinQuantità\n";
    inventory.forEach(p=>{ csv+=`${p.brand},${p.qty},${p.price},${p.minQty||""}\n`});
    const blob = new Blob([csv], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download="inventario.csv"; a.click(); URL.revokeObjectURL(url);
  }

  // --- UI Helpers ---
  const todaysOrders = orders.filter(o=>o.date.slice(0,10)===filterDate);
  const totalToday = todaysOrders.reduce((s,o)=>s+o.total,0);

  return (
    <div className="min-h-screen flex flex-col font-sans">
      <header className="bg-indigo-600 text-white p-4 flex justify-between items-center">
        <h1 className="text-lg font-bold">Inventario Bar / Tabacchi</h1>
        <nav className="flex gap-2 text-sm flex-wrap">
          <button className="px-2 py-1 bg-indigo-400 rounded" onClick={()=>setPage("inventory")}>Inventario</button>
          <button className="px-2 py-1 bg-indigo-400 rounded" onClick={()=>setPage("add")}>Nuovo</button>
          <button className="px-2 py-1 bg-indigo-400 rounded" onClick={()=>setPage("reload")}>Ricarica</button>
          <button className="px-2 py-1 bg-indigo-400 rounded" onClick={()=>setPage("unload")}>Scarico</button>
        </nav>
      </header>

      <main className="flex-1 p-4 overflow-auto">
        {page==="inventory" && (
          <div>
            <div className="flex justify-between items-center mb-3 flex-wrap">
              <h2 className="text-lg font-semibold">Inventario</h2>
              <button className="px-2 py-1 bg-green-600 text-white rounded text-sm" onClick={exportCSV}>CSV</button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm border-collapse">
                <thead className="bg-gray-200">
                  <tr><th className="border p-1">Marca</th><th className="border p-1">Qty</th><th className="border p-1">Prezzo</th><th className="border p-1">MinQty</th></tr>
                </thead>
                <tbody>
-                 {inventory.map(p=>(
-                   <tr key={p.brand} className="border-t">
+                 {inventory.map((p,i)=>(
+                   <tr key={i} className="border-t">
                      <td className="p-1">{p.brand}</td>
                      <td className={`p-1 ${p.minQty && p.qty < p.minQty ? "text-red-600 font-bold" : ""}`}>{p.qty}</td>
                      <td className="p-1">{currency(p.price)}</td>
                      <td className="p-1">{p.minQty||""}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {page==="add" && (
          <form className="max-w-md mx-auto bg-white p-4 rounded shadow" onSubmit={addProduct}>
            <h2 className="text-lg font-semibold mb-2">Aggiungi nuovo prodotto</h2>
            <input type="text" placeholder="Marca" className="w-full p-2 border mb-2 rounded" value={newProduct.brand} onChange={e=>setNewProduct({...newProduct, brand:e.target.value})}/>
            <input type="number" placeholder="Quantità" className="w-full p-2 border mb-2 rounded" value={newProduct.qty} onChange={e=>setNewProduct({...newProduct, qty:e.target.value})}/>
            <input type="number" placeholder="Prezzo €" step="0.01" className="w-full p-2 border mb-2 rounded" value={newProduct.price} onChange={e=>setNewProduct({...newProduct, price:e.target.value})}/>
            <input type="number" placeholder="Quantità minima (alert)" className="w-full p-2 border mb-2 rounded" value={newProduct.minQty} onChange={e=>setNewProduct({...newProduct, minQty:e.target.value})}/>
            <button className="px-3 py-1 bg-indigo-600 text-white rounded">Salva</button>
          </form>
        )}

        {page==="reload" && (
          <form className="max-w-md mx-auto bg-white p-4 rounded shadow" onSubmit={reloadProduct}>
            <h2 className="text-lg font-semibold mb-2">Ricarica quantità prodotto</h2>
            <select className="w-full p-2 border mb-2 rounded" value={reloadForm.brand} onChange={e=>setReloadForm(prev=>({...prev,brand:e.target.value}))}>
              <option value="">-- Seleziona marca --</option>
-             {inventory.map(p=><option key={p.brand} value={p.brand}>{p.brand}</option>)}
+             {inventory.map((p,i)=><option key={i} value={p.brand}>{p.brand}</option>)}
            </select>
            <input type="number" placeholder="Quantità da aggiungere" className="w-full p-2 border mb-2 rounded" value={reloadForm.qty} onChange={e=>setReloadForm(prev=>({...prev,qty:e.target.value}))}/>
            <input type="number" placeholder="Prezzo € (lascia se non cambia)" step="0.01" className="w-full p-2 border mb-2 rounded" value={reloadForm.price} onChange={e=>setReloadForm(prev=>({...prev,price:e.target.value}))}/>
            <button className="px-3 py-1 bg-indigo-600 text-white rounded">Aggiorna</button>
          </form>
        )}

        {page==="unload" && (
          <form className="max-w-md mx-auto bg-white p-4 rounded shadow" onSubmit={unloadMulti}>
            <h2 className="text-lg font-semibold mb-2">Scarico multiplo</h2>
            {multiUnload.map((m,i)=>(
              <div key={i} className="flex gap-2 mb-2">
                <select className="flex-1 p-2 border rounded" value={m.brand} onChange={e=>{
                  setMultiUnload(prev=>{
                    const copy = [...prev];
                    copy[i] = {...copy[i], brand:e.target.value};
                    return copy;
                  })
                }}>
                  <option value="">-- Marca --</option>
                  {inventory.map((p,j)=><option key={j} value={p.brand}>{p.brand}</option>)}
                </select>
                <input type="number" placeholder="Quantità" className="w-28 p-2 border rounded" value={m.qty} onChange={e=>{
                  setMultiUnload(prev=>{
                    const copy = [...prev];
                    copy[i] = {...copy[i], qty:e.target.value};
                    return copy;
                  })
                }}/>
                {i===multiUnload.length-1 && <button type="button" className="px-2 bg-green-500 text-white rounded" onClick={()=>setMultiUnload(prev=>[...prev,{brand:"",qty:""}])}>+</button>}
              </div>
            ))}
            <button className="px-3 py-1 bg-indigo-600 text-white rounded">Scarica</button>
          </form>
        )}
      </main>

      <div className="fixed bottom-2 right-2 text-gray-400 text-xs select-none pointer-events-none">Ste - 2025</div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
